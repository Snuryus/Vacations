#!perl
=head1 NAME

  Vacations module

=cut


use strict;
use warnings FATAL => 'all';

use Vacations::db::Vacations;
use Abills::Base qw/_bp sendmail/;

our(
  %lang,
  $html,
  $admin,
  $user,
  $db,
  %conf,
  @MODULES,
);

my $Vacations = Vacations->new($db, $admin, \%conf);
my $User = Users->new($db, $admin, \%conf);


#**********************************************************
=head2 vacations_user_info($attr)

=cut
#**********************************************************
sub vacations_user_info {

  if ($FORM{CHANGE_PASSWORD} || $FORM{newpassword}) {
    form_passwd();
  }

  if ($FORM{first_login} && $FORM{passwd} && $FORM{user}) {
    $html->message('info', $lang{INFO}, "Ваш логин: $FORM{user}\nВаш пароль: $FORM{passwd}");
  }

  $Vacations->info($user->{UID});

  if($Vacations->{ROLE} < 1) {
    $html->message('warn', $lang{WARNING}, "Ваш доступ заблокирован. Обратитесь к администратору.");
    return 1;
  }

  $Vacations->{CHANGE_PASSWORD} = $html->button($lang{CHANGE_PASSWORD}, "index=10&CHANGE_PASSWORD=1&sid=$sid", { class => 'btn btn-sm btn-primary' });
  $Vacations->{VACATION_REQUEST} = $html->button("Заявление о предоставлении отпуска", "index=10&VACATION_REQUEST=1&sid=$sid", { class => 'btn btn-block btn-success' });
  $html->tpl_show(_include('vacations_user_info', 'Vacations'), $Vacations);

  return 1;
}

#**********************************************************
=head2 vacations_registration($attr)

=cut
#**********************************************************
sub vacations_registration {
  
  if ( $FORM{reg} ) {
    if (!$FORM{EMAIL} || $FORM{EMAIL} !~ /^(([^<>()[\]\\.,;:\s\@\"]+(\.[^<>()[\]\\.,;:\s\@\"]+)*)|(\".+\"))\@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/) {
      $Vacations->{MESSAGE} = $html->message('err', $lang{ERROR}, "$lang{ERR_WRONG_EMAIL}");
    }
    elsif ($FORM{TID}) {
      my $main_info = $Vacations->main_info($FORM{TID});
      if ($Vacations->{TOTAL}) {
        $Vacations->{MESSAGE} = $html->message('warn', $lang{ERROR}, "Пользователь с табельным номером $FORM{TID} уже зарегистрирован.");
      }
      else {
        my $emp_info = $Vacations->emp_info($FORM{TID});
        if (!$Vacations->{TOTAL}) {
          $Vacations->{MESSAGE} = $html->message('warn', $lang{ERROR}, "Табельный номер $FORM{TID} не найден.");
        }
        else {
          if ( !$FORM{SURNAME} ) {
            $Vacations->{MESSAGE} = $html->message('warn', $lang{ERROR}, "Укажите вашу фамилию.");
          }
          elsif ($emp_info->[0]->{surname} ne $FORM{SURNAME}) {
            $Vacations->{MESSAGE} = $html->message('warn', $lang{ERROR}, "Фамилия и табельный номер не совпадают.");
          }
          else {
            my $password = mk_unique_value($conf{PASSWD_LENGTH} || 6, { EXTRA_RULES => '0:0' });
            $User->add({ LOGIN => $FORM{TID}, PASSWORD => $password });
            _error_show($User);

            my $uid = $User->{INSERT_ID};
    
            if ( $User->{errno} ) {
              $html->message('err', "$lang{ERROR}", "Ошибка при создании пользователя $FORM{TID}");
              return 0;
            }

            $User->pi_add({ UID => $uid, EMAIL => $FORM{EMAIL} });
            _error_show($User);

            $Vacations->user_add({ TID => $FORM{TID}, UID => $uid });
            _error_show($Vacations);

            if ( $Vacations->{errno} ) {
              $html->message('err', "$lang{ERROR}", "Обратитесь к администратору.");
            }
            else {
              $html->message('info', "$lang{SUCCESS}", "Пользователь $FORM{TID} успешно зарегистрирован.");
              my $login_url = $SELF_URL;
              $login_url =~ s/registration/index/;
              print "Location: $login_url?user=$FORM{TID}&passwd=$password&first_login=1\n\n";
              return 1;
            }
          }
        }

      }
    }
    else {
      $Vacations->{MESSAGE} = $html->message('warn', $lang{ERROR}, "Укажите табельный номер.");
    }
  }

  $html->tpl_show(_include('vacations_user_registration', 'Vacations'), { %{$Vacations}, %FORM }, { ID => 'VACATIONS_REGISTRATION' });
  

  return 1;
}


#**********************************************************
=head2 orders_import($attr)

=cut
#**********************************************************
sub orders_import {
  my $filename = '/usr/abills/var/datain/vacation_orders.csv';
  my @ColumnNames = ('TID', 'ORDER_ID', 'ORDER_DATE', 'VCT_START', 'VCT_END', 'VCT_DAYS', 'USED');

  $Vacations->truncate_table('vacations_orders');

  open FILE, "< $filename" or die  "Can't open $filename : $!";

  my $columns = <FILE>;

  while (<FILE>) {
    chomp $_;
    my %hash;
    @hash{@ColumnNames} = split (';');
    $hash{ORDER_DATE} = _str_to_date($hash{ORDER_DATE});
    $hash{VCT_START} = _str_to_date($hash{VCT_START});
    $hash{VCT_END} = _str_to_date($hash{VCT_END});

    $Vacations->add('vacations_orders', \%hash);
    _error_show($Vacations);
  }

  close FILE;
  return 1;

}

#**********************************************************
=head2 holidays_import($attr)

=cut
#**********************************************************
sub holidays_import {
  my $filename = '/usr/abills/var/datain/Holidays.csv';
  my @ColumnNames = ('DATE', 'WORKDAY');

  $Vacations->truncate_table('vacations_holidays');

  open FILE, "< $filename" or die  "Can't open $filename : $!";

  my $columns = <FILE>;

  while (<FILE>) {
    chomp $_;
    my %hash;
    @hash{@ColumnNames} = split (';');
    $hash{DATE} = _str_to_date($hash{DATE});

    $Vacations->add('vacations_holidays', \%hash);
    _error_show($Vacations);
  }

  close FILE;
  return 1;

}

#**********************************************************
=head2 accrued_import($attr)

=cut
#**********************************************************
sub accrued_import {
  my $filename = '/usr/abills/var/datain/vacation_acrule_periods.csv';
  my @ColumnNames = ('TID', 'START_PERIOD', 'END_PERIOD', 'DAYS_ACCRUED', 'DAYS_USED');

  $Vacations->truncate_table('vacations_accrued_periods');

  open FILE, "< $filename" or die  "Can't open $filename : $!";

  my $columns = <FILE>;

  while (<FILE>) {
    chomp $_;
    my %hash;
    @hash{@ColumnNames} = split (';');
    $hash{START_PERIOD} = _str_to_date($hash{START_PERIOD});
    $hash{END_PERIOD} = _str_to_date($hash{END_PERIOD});

    $Vacations->add('vacations_accrued_periods', \%hash);
    _error_show($Vacations);
  }

  close FILE;
  return 1;

}

#**********************************************************
=head2 orders_import($attr)

=cut
#**********************************************************
sub employees_import {
  my $filename = '/usr/abills/var/datain/employees.csv';
  my @ColumnNames = ('TID', 'SURNAME', 'NAME', 'MID_NAME', 'SURNAME_GENETIVE', 'START_DATE', 'POSITION', 'VCT_DAYS', 'COMPANY', 'VCT_LEFT');

  $Vacations->truncate_table('vacations_employees');

  open FILE, "< $filename" or die  "Can't open $filename : $!";

  my $columns = <FILE>;

  while (<FILE>) {
    chomp $_;
    my %hash;
    @hash{@ColumnNames} = split (';');
    $hash{START_DATE} = _str_to_date($hash{START_DATE});

    $Vacations->add('vacations_employees', \%hash);
    _error_show($Vacations);
  }

  close FILE;
  return 1;

}

#**********************************************************
=head2 _str_to_date($attr)

convert 01.02.17 to 2017-02-01

=cut
#**********************************************************
sub _str_to_date {
  my ($str) = @_;
  return "20" . join '-', reverse split '\.', $str;
}

#**********************************************************
=head2 vct_history($attr)

=cut
#**********************************************************
sub vct_history {
  
  $Vacations->info($user->{UID});
  if($Vacations->{ROLE} < 1) {
    $html->message('warn', $lang{WARNING}, "Ваш доступ заблокирован. Обратитесь к администратору.");
    return 1;
  }

  my $vct_list = $Vacations->orders_list($Vacations->{TID});

  my $table = $html->table({
    width         => '100%',
    caption       => "История отпусков",
    border        => 1,
    title_plain   => [ "Приказ №", "Дата приказа", "Начало отпуска", "Конец отпуска", "Длительность отпуска" ],
    ID            => 'orders',
  });
  
  my $total_days = 0;

  foreach my $vct_line ( @$vct_list ) {
    $table->addrow($vct_line->{order_id}, $vct_line->{order_date}, $vct_line->{vct_start}, $vct_line->{vct_end}, $vct_line->{vct_days});
    $total_days += $vct_line->{vct_days};
  }
  
  $table->addrow("Всего:", '', '', '', $total_days );

  print $table->show();

  return 1;
}

#**********************************************************
=head2 vct_periods($attr)

=cut
#**********************************************************
sub vct_periods {

  $Vacations->info($user->{UID});
  if($Vacations->{ROLE} < 1) {
    $html->message('warn', $lang{WARNING}, "Ваш доступ заблокирован. Обратитесь к администратору.");
    return 1;
  }

  my $periods_list = $Vacations->periods_list($Vacations->{TID});

  my $table = $html->table({
    width         => '100%',
    caption       => "История отпусков",
    border        => 1,
    title_plain   => [ "Начало периода", "Конец периода", "Начислено отпускных дней", "Использовано отпускных дней" ],
    ID            => 'orders',
  });
  
  my $total_days_used = 0;
  my $total_days_accrued = 0;

  foreach my $period_line ( @$periods_list ) {
    $table->addrow($period_line->{start_period}, $period_line->{end_period}, $period_line->{days_accrued}, $period_line->{days_used});
    $total_days_used += $period_line->{days_used};
    $total_days_accrued += $period_line->{days_accrued};
  }
  
  $table->addrow("Всего:", '', $total_days_accrued, $total_days_used );

  print $table->show();
  
  return 1;
}

#**********************************************************
=head2 user_role($uid)

=cut
#**********************************************************
sub user_role {
  my ($uid) = @_;

  $Vacations->info($uid);

  return $Vacations->{ROLE} || -1;
}

#**********************************************************
=head2 vacations_users_list()

=cut
#**********************************************************
sub vacations_users_list {

  my $u_role = user_role($user->{UID});
  
  if($FORM{DELETE} && $u_role == 3 ) {
    $Vacations->user_del($FORM{DELETE}, 'users_pi');
    $Vacations->user_del($FORM{DELETE}, 'vacations_main');
    $Vacations->user_del($FORM{DELETE}, 'users');
  }
  elsif($FORM{ROLE_2}) {
    $Vacations->user_change($FORM{ROLE_2}, '2');
  }
  elsif($FORM{ROLE_1}) {
    $Vacations->user_change($FORM{ROLE_1}, '1');
  }
  elsif($FORM{ENABLE}) {
    $Vacations->user_change($FORM{ENABLE}, '1');
  }
  elsif($FORM{DISABLE}) {
    $Vacations->user_change($FORM{DISABLE}, '0');
  }
  elsif($FORM{NEW_EMAIL}) {
    $User->pi_change({ UID => $FORM{CHG_EMAIL}, EMAIL => $FORM{NEW_EMAIL} });
    _error_show($User);
  }
  elsif($FORM{CHG_EMAIL}) {
    $Vacations->info($FORM{CHG_EMAIL});
    $html->tpl_show(_include('vacations_change_email', 'Vacations'), { %$Vacations, %FORM });
  }
  elsif($FORM{NEW_PSWD}) {
    $User->change($FORM{CHG_PSWD}, { UID => $FORM{CHG_PSWD}, PASSWORD => $FORM{NEW_PSWD} });
    if ($FORM{SEND_EMAIL}) {
      $Vacations->info($FORM{CHG_PSWD});
      my $message = "LOGIN: $Vacations->{TID}\nPASSWORD: $FORM{NEW_PSWD}";
      print $html->header();
      sendmail("$conf{ADMIN_MAIL}", "$Vacations->{EMAIL}", "Password Recovery", "$message", "$conf{MAIL_CHARSET}", "", {TEST => 1});
    }
  }
  elsif($FORM{CHG_PSWD}) {
    $Vacations->info($FORM{CHG_PSWD});
    $html->tpl_show(_include('vacations_change_pswd', 'Vacations'), { %$Vacations, %FORM });
  }

  my $user_list = $Vacations->users_list();
  
  my $table = $html->table({
    width         => '100%',
    caption       => "Список пользователей",
    border        => 1,
    title_plain   => [ "Табельный номер", "ФИО", "E-mail", "Права доступа", "", "" ],
    ID            => 'users',
  });

  foreach my $user_line ( @$user_list ) {
    my $delete_button = $html->button("Удалить", "index=$index&DELETE=$user_line->{uid}&sid=$sid", { class => 'del' }) if ($u_role == 3);
    my $block_button = $html->button("заблокировать", "index=$index&DISABLE=$user_line->{uid}&sid=$sid", { class => '_on' });
    
    my $fio = "$user_line->{surname} $user_line->{name} $user_line->{mid_name}";
    my $chg_pswd_button = $html->button("изменить пароль", "index=$index&CHG_PSWD=$user_line->{uid}&sid=$sid", { class => 'password' });
    my $chg_email_button = $html->button($user_line->{email} || "Не указано", "index=$index&CHG_EMAIL=$user_line->{uid}&sid=$sid");
    
    if (!$user_line->{tid}) {
      $table->addrow($user_line->{login}, "Не найдено соответствующего сотрудника", '', '', '', '', $delete_button);
    }
    else {
      my @roles = ("Заблокирован", 
        $html->button("Сотрудник", "index=$index&ROLE_2=$user_line->{uid}&sid=$sid"),
        $html->button("Администратор", "index=$index&ROLE_1=$user_line->{uid}&sid=$sid"),
        "Системный администратор"
      );
      my $chg_role_button = $roles[$user_line->{role}];
      if ($user_line->{role} == 0) {
        $block_button = $html->button("разблокировать", "index=$index&ENABLE=$user_line->{uid}&sid=$sid",  { class => 'off' });  
      }
      $table->addrow($user_line->{login}, $fio, $chg_email_button, $chg_role_button, $chg_pswd_button, $block_button,  $delete_button);
    }
  }

  print $table->show();

  return 1;
}

#**********************************************************
=head2 vacations_emp_list()

=cut
#**********************************************************
sub vacations_emp_list {

  if ($FORM{EMAIL} && $FORM{TID}) {
    my $password = mk_unique_value($conf{PASSWD_LENGTH} || 6, { EXTRA_RULES => '0:0' });
    $User->add({ LOGIN => $FORM{TID}, PASSWORD => $password });
    _error_show($User);

    my $uid = $User->{INSERT_ID};
    
    if ( $User->{errno} ) {
      $html->message('err', "$lang{ERROR}", "Ошибка при создании пользователя $FORM{TID}");
      return 0;
    }

    $User->pi_add({ UID => $uid, EMAIL => $FORM{EMAIL} });
    _error_show($User);

    $Vacations->user_add({ TID => $FORM{TID}, UID => $uid });
    _error_show($Vacations);

    if ($FORM{SEND_EMAIL}) {
      my $message = "LOGIN: $FORM{TID}\nPASSWORD: $password";
      print $html->header();
      sendmail("$conf{ADMIN_MAIL}", "$FORM{EMAIL}", "Password Recovery", "$message", "$conf{MAIL_CHARSET}", "", {TEST => 1});

    }
  }
  elsif ($FORM{USER_ADD}) {
    $html->tpl_show(_include('vacations_user_reg', 'Vacations'), { TID => $FORM{USER_ADD}, %FORM });
  }


  my $emp_list = $Vacations->emp_list();
  my @roles = ("Заблокирован", "Сотрудник", "Администратор", "Системный администратор");
  
  my $table = $html->table({
    width         => '100%',
    caption       => "Список сотрудников",
    border        => 1,
    title_plain   => [ "Табельный номер", "ФИО", "Пользователь"],
    ID            => 'employees',
  });

  foreach my $emp_line ( @$emp_list ) {
    my $fio = "$emp_line->{surname} $emp_line->{name} $emp_line->{mid_name}";
    if ($emp_line->{uid}) {
      $table->addrow($emp_line->{tid}, $fio, $roles[$emp_line->{role}]);
    }
    else {
      my $user_add_button = $html->button("Создать аккаунт", "index=$index&USER_ADD=$emp_line->{tid}&SURNAME=$emp_line->{surname}&sid=$sid", { class => 'btn btn-xs btn-success' });
      $table->addrow($emp_line->{tid}, $fio, $user_add_button);
    }
  }

  print $table->show();

  return 1;


  return 1;
}

1